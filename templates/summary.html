{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Research Summary</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <span class="badge bg-success">
                <i class="bi bi-robot"></i> Auto-generated weekly
            </span>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="summaryTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
            <i class="bi bi-file-text"></i> General Summaries
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="specialized-tab" data-bs-toggle="tab" data-bs-target="#specialized" type="button" role="tab">
            <i class="bi bi-search"></i> Specialized Summaries
        </button>
    </li>
</ul>

<div class="tab-content" id="summaryTabContent">
    <!-- General Summaries Tab -->
    <div class="tab-pane fade show active" id="general" role="tabpanel">
        <div class="row mb-4">
            {% for lang_code, lang_name in [('en', 'English'), ('fr', 'Français'), ('ru', 'Русский')] %}
            <div class="col-md-4 mb-3">
                <div class="card stats-card h-100 summary-box-clickable" onclick="showSummary('{{ lang_code }}')" style="cursor: pointer;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">{{ lang_name }} Summary</h6>
                                {% if summary_info[lang_code]['exists'] %}
                                    <span class="badge bg-success">Available</span>
                                    <small class="d-block text-muted mt-1">
                                        Version {{ summary_info[lang_code]['version'] }}<br>
                                        {{ summary_info[lang_code]['paper_count'] }} papers<br>
                                        <em>Auto-updated weekly</em>
                                    </small>
                                {% else %}
                                    <span class="badge bg-warning">Being Generated</span>
                                    <small class="d-block text-muted mt-1">
                                        <em>Will be ready Monday</em>
                                    </small>
                                {% endif %}
                            </div>
                            <div>
                                <i class="bi bi-eye text-primary" style="font-size: 1.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Summary Display Area -->
        <div class="card stats-card" id="generalSummaryDisplay" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0" id="generalSummaryTitle">Summary</h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copySummaryToClipboard('general')">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="closeSummary('general')">
                        <i class="bi bi-x"></i> Close
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="generalSummaryContent">
                    <!-- Summary content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Specialized Summaries Tab -->
    <div class="tab-pane fade" id="specialized" role="tabpanel">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Create focused summaries by selecting specific key terms. These summaries analyze only papers containing your chosen terms.
        </div>
        
        <!-- Generation Panel -->
        <div class="row">
            <div class="col-lg-4">
                <div class="card stats-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Create Specialized Summary</h5>
                    </div>
                    <div class="card-body">
                        <form id="specializedSummaryForm">
                            <div class="mb-3">
                                <label for="specializedLanguage" class="form-label">Language</label>
                                <select class="form-select" id="specializedLanguage" name="language">
                                    <option value="en">English</option>
                                    <option value="fr">Français</option>
                                    <option value="ru">Русский</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Focus Terms (Required)</label>
                                <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;" id="specializedKeyTermsContainer">
                                    <div class="text-center text-muted" id="loadingSpecializedTerms">
                                        <i class="bi bi-hourglass-split"></i> Loading key terms...
                                    </div>
                                </div>
                                <small class="text-muted">Select terms to focus the summary on specific aspects of AML research.</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="summaryName" class="form-label">Summary Name</label>
                                <input type="text" class="form-control" id="summaryName" placeholder="e.g., TP53 & VENETOCLAX Research">
                                <small class="text-muted">Give your specialized summary a descriptive name.</small>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-custom" id="generateSpecializedBtn">
                                    <i class="bi bi-gear"></i> Generate Specialized Summary
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Specialized Summary Display -->
            <div class="col-lg-8">
                <div class="card stats-card" id="specializedSummaryDisplay">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Specialized Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="specializedSummaryResult">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-search fs-1"></i>
                                <p class="mt-3">No specialized summary generated yet.</p>
                                <p class="small">Select key terms and click "Generate Specialized Summary" to create a focused analysis.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Saved Specialized Summaries -->
                <div class="card stats-card mt-3" id="savedSpecializedSummaries" style="display: none;">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Saved Specialized Summaries</h6>
                    </div>
                    <div class="card-body">
                        <div id="savedSummariesList">
                            <!-- Saved summaries will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
let currentGeneralSummary = null;
let specializedKeyTerms = [];
let currentOpenSummary = null; // Track which general summary is currently open
let currentOpenSpecializedSummary = null; // Track which specialized summary is currently open

// Function to convert markdown to HTML
function formatMarkdownToHTML(markdown) {
    if (!markdown) return '';
    
    let html = markdown;
    
    // Convert headers
    html = html.replace(/^### (.*$)/gim, '<h5 class="mt-4 mb-2 text-primary">$1</h5>');
    html = html.replace(/^## (.*$)/gim, '<h4 class="mt-4 mb-3 text-primary">$1</h4>');
    html = html.replace(/^# (.*$)/gim, '<h3 class="mt-4 mb-3 text-primary">$1</h3>');
    
    // Convert bold and italic
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Convert bullet points
    html = html.replace(/^- (.*$)/gim, '<li class="mb-1">$1</li>');
    
    // Convert numbered lists
    html = html.replace(/^\d+\. (.*$)/gim, '<li class="mb-1">$1</li>');
    
    // Wrap lists in ul/ol tags (simple approach)
    html = html.replace(/(<li class="mb-1">.*<\/li>)/gs, '<ul class="mb-3">$1</ul>');
    
    // Fix nested lists (basic cleanup)
    html = html.replace(/<\/ul>\s*<ul class="mb-3">/g, '');
    
    // Convert paragraphs (double line breaks)
    html = html.replace(/\n\n/g, '</p><p class="mb-3">');
    html = '<p class="mb-3">' + html + '</p>';
    
    // Clean up empty paragraphs and fix header wrapping
    html = html.replace(/<p class="mb-3"><\/p>/g, '');
    html = html.replace(/<p class="mb-3">(<h[1-6])/g, '$1');
    html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
    html = html.replace(/<p class="mb-3">(<ul)/g, '$1');
    html = html.replace(/(<\/ul>)<\/p>/g, '$1');
    
    // Convert single line breaks to <br> within paragraphs
    html = html.replace(/\n/g, '<br>');
    
    return html;
}

// Load general summary when clicking on language box - with toggle functionality
function showSummary(language) {
    const titleElement = document.getElementById('generalSummaryTitle');
    const contentElement = document.getElementById('generalSummaryContent');
    const displayElement = document.getElementById('generalSummaryDisplay');
    
    // Toggle functionality - if the same summary is already open, close it
    if (currentOpenSummary === language && displayElement.style.display === 'block') {
        displayElement.style.display = 'none';
        currentOpenSummary = null;
        return;
    }
    
    // Set as current open summary
    currentOpenSummary = language;
    
    titleElement.textContent = `${getLanguageName(language)} Summary`;
    contentElement.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Loading summary...</div>';
    displayElement.style.display = 'block';
    
    // Scroll to summary display
    displayElement.scrollIntoView({ behavior: 'smooth' });
    
    // Fetch summary content
    fetch(`/api/get_summary/${language}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                const summary = data.summary;
                let html = `
                    <div class="mb-3">
                        <div class="row text-center mb-3">
                            <div class="col-3">
                                <div class="fw-bold text-primary">${summary.paper_count}</div>
                                <small class="text-muted">Papers Analyzed</small>
                            </div>
                            <div class="col-3">
                                <div class="fw-bold text-success">v${summary.version}</div>
                                <small class="text-muted">Version</small>
                            </div>
                            <div class="col-6">
                                <div class="fw-bold text-info">${new Date(summary.generated_at).toLocaleDateString()}</div>
                                <small class="text-muted">Last Updated</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-content">
                        ${formatMarkdownToHTML(summary.content)}
                    </div>
                `;
                
                // Add trends if available
                if (summary.trends && summary.trends.key_trends) {
                    html += `
                        <div class="mt-4">
                            <h6>Key Research Trends</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Emerging Trends:</strong>
                                    <ul class="small">
                                        ${summary.trends.key_trends.slice(0, 3).map(trend => `<li>${trend}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <strong>Therapeutic Targets:</strong>
                                    <ul class="small">
                                        ${summary.trends.therapeutic_targets.slice(0, 3).map(target => `<li>${target}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <strong>Prognostic Markers:</strong>
                                    <ul class="small">
                                        ${summary.trends.prognostic_markers.slice(0, 3).map(marker => `<li>${marker}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                contentElement.innerHTML = html;
                currentGeneralSummary = summary.content;
            } else {
                contentElement.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        No summary available for ${getLanguageName(language)} yet. 
                        It will be generated during the next weekly update.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading summary:', error);
            contentElement.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle"></i>
                    Error loading summary. Please try again later.
                </div>
            `;
        });
}

function closeSummary(type) {
    if (type === 'general') {
        document.getElementById('generalSummaryDisplay').style.display = 'none';
        currentOpenSummary = null; // Reset tracking
    }
}

function exportSummaryToPDF(type) {
    let content = '';
    let title = '';
    let language = 'en';
    
    if (type === 'general' && currentGeneralSummary) {
        content = currentGeneralSummary;
        title = `${getLanguageName(currentOpenSummary)} Research Summary`;
        language = currentOpenSummary || 'en';
    } else if (type === 'specialized') {
        // Get specialized summary content from the display
        const resultDiv = document.getElementById('specializedSummaryResult');
        const summaryContent = resultDiv.querySelector('.summary-content');
        if (summaryContent) {
            content = summaryContent.innerText || summaryContent.textContent;
            title = resultDiv.querySelector('h6')?.textContent || 'Specialized Summary';
            // Extract language from the display if available
            language = 'en'; // Default, could be enhanced to detect from content
        }
    }
    
    if (!content) {
        alert('No summary content available to export');
        return;
    }
    
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
    btn.disabled = true;
    
    // Call the API to generate PDF
    fetch('/api/export_summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            summary: content,
            language: language,
            title: title
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        // Open PDF in new tab
        const url = window.URL.createObjectURL(blob);
        window.open(url, '_blank');
        
        // Clean up the URL after a delay
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
        }, 1000);
        
        // Show success state
        btn.innerHTML = '<i class="bi bi-check"></i> Opened!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-primary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
            btn.disabled = false;
        }, 2000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error exporting summary to PDF');
        
        // Reset button state
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function exportSpecializedSummaryToPDF(summaryId) {
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
    btn.disabled = true;
    
    // Fetch the specialized summary data
    fetch(`/api/specialized_summary/${summaryId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.summary) {
                throw new Error('Summary not found');
            }
            
            const summary = data.summary;
            const title = `${summary.name} - Specialized Summary`;
            
            // Call the API to generate PDF
            return fetch('/api/export_summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    summary: summary.content,
                    language: summary.language,
                    title: title,
                    focus_terms: summary.focus_terms
                })
            });
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Export failed');
        })
        .then(blob => {
            // Open PDF in new tab
            const url = window.URL.createObjectURL(blob);
            window.open(url, '_blank');
            
            // Clean up the URL after a delay
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
            }, 1000);
            
            // Show success state
            btn.innerHTML = '<i class="bi bi-check"></i> Opened!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-primary');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
                btn.disabled = false;
            }, 2000);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error exporting specialized summary to PDF');
            
            // Reset button state
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function copySummaryToClipboard(type) {
    let content = '';
    
    if (type === 'general' && currentGeneralSummary) {
        content = currentGeneralSummary;
    } else if (type === 'specialized') {
        // Get specialized summary content from the display
        const resultDiv = document.getElementById('specializedSummaryResult');
        const summaryContent = resultDiv.querySelector('.summary-content');
        if (summaryContent) {
            content = summaryContent.innerText || summaryContent.textContent;
        }
    }
    
    if (content) {
        navigator.clipboard.writeText(content).then(function() {
            // Show success feedback
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
            alert('Failed to copy to clipboard');
        });
    } else {
        alert('No content to copy');
    }
}

function getLanguageName(code) {
    const names = {
        'en': 'English',
        'fr': 'Français', 
        'ru': 'Русский'
    };
    return names[code] || code;
}

// Load key terms for specialized summaries
function loadSpecializedKeyTerms() {
    fetch('/api/key_terms')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('specializedKeyTermsContainer');
            
            if (data.key_terms && data.key_terms.length > 0) {
                const sortedTerms = data.key_terms
                    .sort((a, b) => b.frequency - a.frequency)
                    .slice(0, 15); // Show top 15 for specialized summaries
                
                container.innerHTML = '';
                sortedTerms.forEach(term => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${term.term}" 
                               id="specialized_term_${term.term.replace(/[^a-zA-Z0-9]/g, '_')}">
                        <label class="form-check-label" for="specialized_term_${term.term.replace(/[^a-zA-Z0-9]/g, '_')}">
                            ${term.term} <span class="badge bg-secondary">${term.frequency}</span>
                        </label>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<div class="text-muted">No key terms available.</div>';
            }
        })
        .catch(error => {
            console.error('Error loading key terms:', error);
            document.getElementById('specializedKeyTermsContainer').innerHTML = 
                '<div class="text-danger">Error loading key terms.</div>';
        });
}

// Handle specialized summary form submission
document.getElementById('specializedSummaryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const language = document.getElementById('specializedLanguage').value;
    const summaryName = document.getElementById('summaryName').value;
    const selectedTerms = Array.from(document.querySelectorAll('#specializedKeyTermsContainer input:checked'))
        .map(checkbox => checkbox.value);
    
    if (selectedTerms.length === 0) {
        alert('Please select at least one key term to focus the summary.');
        return;
    }
    
    if (!summaryName.trim()) {
        alert('Please provide a name for your specialized summary.');
        return;
    }
    
    // Show loading
    const resultDiv = document.getElementById('specializedSummaryResult');
    resultDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generating...</span>
            </div>
            <p class="mt-3">Generating specialized summary for: ${selectedTerms.join(', ')}</p>
            <small class="text-muted">This may take a few moments...</small>
        </div>
    `;
    
    // Generate specialized summary
    fetch('/api/generate_specialized_summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            language: language,
            selected_terms: selectedTerms,
            summary_name: summaryName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle"></i>
                    Error: ${data.error}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="mb-3">
                    <h6>${summaryName}</h6>
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="fw-bold text-primary">${data.total_papers}</div>
                            <small class="text-muted">Papers Found</small>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold text-success">${selectedTerms.length}</div>
                            <small class="text-muted">Focus Terms</small>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold text-info">${getLanguageName(language)}</div>
                            <small class="text-muted">Language</small>
                        </div>
                    </div>
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> <strong>Specialized Summary Created!</strong><br>
                        <strong>Focus Terms:</strong> ${selectedTerms.join(', ')}<br>
                        <small>Summary ID: ${data.summary_id} | Saved for future access</small>
                    </div>
                    <div class="text-end mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="copySummaryToClipboard('specialized')">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
                
                <div class="summary-content">
                    ${formatMarkdownToHTML(data.summary)}
                </div>
            `;
            
            // Reset form
            document.getElementById('specializedSummaryForm').reset();
            document.querySelectorAll('#specializedKeyTermsContainer input:checked')
                .forEach(cb => cb.checked = false);
            
            // Load saved summaries to show the new one
            loadSavedSpecializedSummaries();
            
            // Set as current open specialized summary
            currentOpenSpecializedSummary = data.summary_id;
        }
    })
    .catch(error => {
        console.error('Error generating specialized summary:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-circle"></i>
                Error generating summary. Please try again later.
            </div>
        `;
    });
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSpecializedKeyTerms();
    loadSavedSpecializedSummaries();
});

// Load saved specialized summaries
function loadSavedSpecializedSummaries() {
    fetch('/api/specialized_summaries')
        .then(response => response.json())
        .then(data => {
            const savedContainer = document.getElementById('savedSpecializedSummaries');
            const savedList = document.getElementById('savedSummariesList');
            
            if (data.summaries && data.summaries.length > 0) {
                savedContainer.style.display = 'block';
                
                let html = '';
                data.summaries.forEach(summary => {
                    const createdDate = new Date(summary.created_at).toLocaleDateString();
                    const focusTermsText = summary.focus_terms.join(', ');
                    
                    html += `
                        <div class="card mb-2">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${summary.name}</h6>
                                        <small class="text-muted">
                                            ${getLanguageName(summary.language)} | ${summary.paper_count} papers | ${createdDate}
                                        </small>
                                        <div class="mt-1">
                                            <span class="badge bg-info">Focus: ${focusTermsText}</span>
                                        </div>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="loadSpecializedSummary(${summary.id})">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteSpecializedSummary(${summary.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                savedList.innerHTML = html;
            } else {
                savedContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading saved summaries:', error);
        });
}

// Load a specific specialized summary - with toggle functionality
function loadSpecializedSummary(summaryId) {
    const resultDiv = document.getElementById('specializedSummaryResult');
    
    // Toggle functionality - if the same summary is already open, close it
    if (currentOpenSpecializedSummary === summaryId) {
        resultDiv.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-search fs-1"></i>
                <p class="mt-3">No specialized summary generated yet.</p>
                <p class="small">Select key terms and click "Generate Specialized Summary" to create a focused analysis.</p>
            </div>
        `;
        currentOpenSpecializedSummary = null;
        return;
    }
    
    // Set as current open specialized summary
    currentOpenSpecializedSummary = summaryId;
    
    fetch(`/api/specialized_summary/${summaryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.summary) {
                const summary = data.summary;
                const resultDiv = document.getElementById('specializedSummaryResult');
                const createdDate = new Date(summary.created_at).toLocaleDateString();
                
                resultDiv.innerHTML = `
                    <div class="mb-3">
                        <h6>${summary.name} <span class="badge bg-secondary">Saved</span></h6>
                        <div class="row text-center mb-3">
                            <div class="col-3">
                                <div class="fw-bold text-primary">${summary.paper_count}</div>
                                <small class="text-muted">Papers</small>
                            </div>
                            <div class="col-3">
                                <div class="fw-bold text-success">${summary.focus_terms.length}</div>
                                <small class="text-muted">Focus Terms</small>
                            </div>
                            <div class="col-3">
                                <div class="fw-bold text-info">${getLanguageName(summary.language)}</div>
                                <small class="text-muted">Language</small>
                            </div>
                            <div class="col-3">
                                <div class="fw-bold text-muted">${createdDate}</div>
                                <small class="text-muted">Created</small>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>Focus Terms:</strong> ${summary.focus_terms.join(', ')}
                        </div>
                        <div class="text-end mb-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="copySummaryToClipboard('specialized')">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="summary-content">
                        ${formatMarkdownToHTML(summary.content)}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading specialized summary:', error);
            alert('Error loading summary');
        });
}

// Delete a specialized summary
function deleteSpecializedSummary(summaryId) {
    if (confirm('Are you sure you want to delete this specialized summary?')) {
        fetch(`/api/specialized_summary/${summaryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Summary deleted successfully');
                loadSavedSpecializedSummaries(); // Refresh the list
                
                // Clear the display if this summary was being viewed
                const resultDiv = document.getElementById('specializedSummaryResult');
                resultDiv.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-search fs-1"></i>
                        <p class="mt-3">No specialized summary generated yet.</p>
                        <p class="small">Select key terms and click "Generate Specialized Summary" to create a focused analysis.</p>
                    </div>
                `;
                
                // Reset tracking variable
                currentOpenSpecializedSummary = null;
            } else {
                alert('Error deleting summary: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting summary:', error);
            alert('Error deleting summary');
        });
    }
}
</script>
{% endblock %}
